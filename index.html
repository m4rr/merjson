<style>
  textarea {
    width: 100%;
    height: 85vh;
  }
</style>

<h2>Drop here the `original.json` and a new `xhr_file` (no ext.)</h2>
<input type="file" id="files" name="files[]" multiple />
<br>
<button id="merge">M E R G E</button>
<button id="save">Save</button>
<br>
<span id="count"></span>
<br>
<div id="areas"></div>
<textarea id="t0"></textarea>

<!-- <script src="deepmerge.js"></script> -->
<script>
  function handleFileSelect(evt) {
    var files = evt.target.files; // FileList object
    var files_count = files.length;
    let result = [];

    for (let i = 0; i < files.length; i++) {
      let f = files[i];
      var reader = new FileReader();

      reader.onload = (function(file) {
        return function(e) {
          let text = e.target.result;
          let json1 = JSON.parse(text);

          if (file.name.includes(".json")) {
            // production file
            document.getElementById('count').innerHTML += json1.length + ", ";

            result.push(clean_up(json1));
          } else {
            // XHR file
            document.getElementById('count').innerHTML += json1.cities.length + ", ";

            result.push(clean_up(json1.cities));
          }

          if (!--files_count) {
            result.push([{"city_id":101175000,"title_en":"Kawthaung","country_ru":"Бирма","country_en":"Burma","title_ru":"Котонг","y":9.983333,"x":98.55}]);

            merjson(result); // when done, invoke callback
          }
        };
      })(f);

      reader.readAsText(f);
    }
  }

  function clean_up(ary) {
    let obj = ary;

    for (let i = 0; i < obj.length; i++) {
      if (obj[i].title_en === "Mawlamyine") {
        // remove wrong Burma city
        delete obj[i]
        continue
      }

      //obj[i].i = i;
      delete obj[i].i;
      delete obj[i].been_count_msg;
      delete obj[i].want;
      delete obj[i].visited;
      delete obj[i].country_url;
      delete obj[i].been_count;
      delete obj[i].city_url;
      delete obj[i].image_url;

      if (obj[i].country_en === "Ukraine") {
        if (obj[i].title_en !== "Odessa") {
          obj[i].country_en = "Russia"
          obj[i].country_ru = "Россия"
        }
      }
    }

    return obj;
  }

  function merjson(result) {
    //let obj = deepmerge.all(result);
    let obj = result.reduce(function (prev, next) {
      // concat all arrays
      return [...prev, ...next]
    });

    // crazy js way to remove duplicates
    obj = [...new Set(obj.map(JSON.stringify))].map(JSON.parse);

    document.getElementById("t0").innerHTML = JSON.stringify(obj);
    document.getElementById("count").innerHTML += " → " + obj.length;

    download(obj);
  }

  function download(data) {
    //var data = document.getElementById("t0").value;
    var json = JSON.stringify(data);
    var blob = new Blob([json], {type: "text/plain"});
    var url  = URL.createObjectURL(blob);

    var a = document.createElement('a');
    a.download = "cities.json";
    a.href = url;
    a.click();
  }

  document.getElementById('files').addEventListener('change', handleFileSelect, false);
  document.getElementById('merge').addEventListener("click", merjson);
  document.getElementById('save').addEventListener("click", download);
</script>
